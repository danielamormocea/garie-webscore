{% extends "base.html" %}
{% from "./macros.html" import "metricDocs", "formatTrend" %}

{% block title %}{{ urlSlug(data.url) }} &ndash; {{ super() }}{% endblock %}

{% block head %}
{{ super() }}
<style>
  h3 { margin-top: 1em }

  .sparkline canvas{
    vertical-align: text-bottom;
  }

  .sparkline {
    background: transparent;
    height: 100px;
    display: true;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">

  <h3>Report for <a href="{{ data.url }}" target="_blank">{{ urlSlug(data.url) }}</a></h3>

  <p>More detailed information for each metric, including logs with each day's
    results, can be found at the
    <a href="https://garie.eea.europa.eu/" target="_blank">Websites QA dashboard</a>.
  </p>

  <table class="table table-striped table-sm">
    <thead class="thead-dark">
      <tr>
        <th scope="col">Metric</th>
        <th scope="col" class="text-center">Score</th>
        <th scope="col" class="text-center">Evolution</th>
      </tr>
    </thead>
    <tbody>
    {% for metric in metrics %}
      <tr>
        <th scope="row">
          {{ metric.name }}
          {{ metricDocs(metric) }}
        </th>
        {% set result = data.metrics[metric.name] %}
        <td class="{{ metricStyle(metric, result.value) }} text-center">
          {% set report = reportUrl(metric, urlSlug(data.url)) %}
          {% if report %}
            <a href="{{ report }}">
              {{ formatMetric(result.value) }}
              {{ formatTrend(result) }}
            </a>
          {% else %}
            {{ formatMetric(result.value) }}
            {{ formatTrend(result) }}
          {% endif %}
        </td>
        <td class="{{ metricStyle(metric, result.value) }} text-center">
           {% set timeSeries = data.metrics[metric.name].timeSeries %}
           <span class="sparkline" data-sparkline='{{ timeSeries }}'>
           </span>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

</div>
{% endblock %}

{% block finalscripts %}
{{ super() }}

<script src="/static/js/sparkline.js"></script>
<script>
$(document).ready(function(){
  var sparklineSpans = document.getElementsByClassName("sparkline");
  var i;

  for (i = 0; i < sparklineSpans.length; i++) {
    var attr = sparklineSpans[i].getAttribute('data-sparkline');
    var valuesList;
    if (attr === "") {
      // do not display empty sparklines
      continue;
    } else {
      values_list = attr.split(',').map(item => {
        if (! item) return 0;
        return parseInt(item);
      });
    }
    var sparkline = new Sparkline(sparklineSpans[i], {
        lineColor: "#666",
        width: 100,
        dotRadius: 3,
        // using 0 breaks check in sparkline.js
        minValue: 1,
        maxValue: 100
      }
    );
    sparkline.draw(values_list);
  }

});
</script>
{% endblock %}