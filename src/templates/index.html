{% extends "base.html" %}
{% from "./macros.html" import "metricDocs", "formatTrend", "formatSparkline" %}

{% block head %}
{{ super() }}
<link href="https://unpkg.com/bootstrap-table@1.16.0/dist/bootstrap-table.min.css" rel="stylesheet">
<script src="https://unpkg.com/bootstrap-table@1.16.0/dist/bootstrap-table.min.js"></script>
<style>
  .sparkline canvas{
    vertical-align: text-bottom;
  }
  .sparkline {
    background: transparent;
    height: 100px;
    display: true;
  }
</style>
{% endblock %}

{% block content %}
<script>
function getNumber(text) {
  return +(text.match(/\d+/) || [0])[0]
}

function sortNumbers(a, b) {
  return getNumber(a) - getNumber(b)
}
</script>
<div class="container-fluid">

  <p>WebScore is a report of quality metrics for websites, larger values are
  better. The scores are calculated daily using various scanning and monitoring
  tools. Click on a website for details.</p>

  <table
    class="table table-striped table-sm"
    data-toggle="table"
    data-sort-name="total-score"
    data-sort-order="desc">
    <thead class="thead-dark">
      <tr>
        <th scope="col" data-field="rank">Rank</th>
        <th scope="col" data-field="url">Website</th>
        <th scope="col" class="text-center"
          data-field="total-score"
          data-sortable="true"
          data-sorter="sortNumbers">Total score</th>
        <th scope="col" class="text-center"
          data-field="median-score"
          data-sortable="true"
          data-sorter="sortNumbers">Median score</th>
        {% for metric in importantMetrics %}
          <th
            scope="col"
            class="text-center"
            data-field="metric-{{ metric.name }}"
            data-sortable="true"
            data-sorter="sortNumbers">
              {{ metric.name }}
              {{ metricDocs(metric) }}
          </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
    {% for row in data %}
      <tr>
        <th scope="row">
          {{ loop.index }}
        </th>
        <td scope="row">
          {{ urlSlug(row.url) }}
          <br/>
          <a href="{{ row.url }}"
             target="_blank" class="external">View site</a>
             |
          <a href="/site/{{ urlSlug(row.url) }}" class="external">View report</a>
        </td>
        <td class="text-center">
          {{ row.score }}
          - <a href="/site/{{ urlSlug(row.url) }}">Full report</a>
        </td>
        <td class="text-center">
          {{ row.median }}
        </td>
        {% for metric in importantMetrics %}
          {% set result = row.metrics[metric.name] %}
          {% set timeSeries = row.metrics[metric.name].timeSeries %}
          <td class="{{ metricStyle(metric, result.value) }} text-center">
            {{ formatMetric(result.value) }}
            <br/>
            <span class="sparkline" data-sparkline='{{ timeSeries }}'>
            </span>
          </td>
        {% endfor %}
      </tr>
    {% endfor %}
    </tbody>
  </table>

</div>
{% endblock %}

{% block finalscripts %}
{{ super() }}

<script src="/static/js/sparkline.js"></script>
<script>
$(document).ready(function(){
  var sparklineSpans = document.getElementsByClassName("sparkline");
  var i;

  for (i = 0; i < sparklineSpans.length; i++) {
    var attr = sparklineSpans[i].getAttribute('data-sparkline');
    var valuesList;
    if (attr === "") {
      // do not display empty sparklines
      continue;
    } else {
      values_list = attr.split(',').map(item => {
        if (! item) return 0;
        return parseInt(item);
      });
    }
    var sparkline = new Sparkline(sparklineSpans[i], {
        lineColor: "#666",
        width: 100,
        dotRadius: 3,
        // using 0 breaks check in sparkline.js
        minValue: 1,
        maxValue: 100
      }
    );
    sparkline.draw(values_list);
  }

});
</script>
{% endblock %}